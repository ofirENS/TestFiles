<!-- saved from url=(0014)about:internet -->
<pre class="code">
<span class="srcline"><span class="lineno"><a href="1,1" id="srcline1">  1</a></span><span class="line"><span class="keyword">function</span> [<span class="var type1" id="S2T27U3">u</span>,<span class="var type1" id="S3T28U4">r</span>]= TestBemHeatEq_optimized(<span class="var type1" id="S4T1U7">sigIn</span>)</span></span>
<span class="srcline"><span class="lineno"><a href="1,2" id="srcline2">  2</a></span><span class="line"><span class="comment">% Solve the inveerse heat equation with an unknown source</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,3" id="srcline3">  3</a></span><span class="line"><span class="comment">% u_t(x,t) = ku_{xx}(x,y) +r(t)*f(x,t)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,4" id="srcline4">  4</a></span><span class="line"><span class="comment">% with 0&lt;=x&lt;=1, 0&lt;=t&lt;=T</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,5" id="srcline5">  5</a></span><span class="line"><span class="comment">% subject to the boundary conditions u(0,t) = u(1,t)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,6" id="srcline6">  6</a></span><span class="line"><span class="comment">% and u_x(0,t)+alpha*u(0,t)=0</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,7" id="srcline7">  7</a></span><span class="line"><span class="comment">% and initial condition</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,8" id="srcline8">  8</a></span><span class="line"><span class="comment">% u(x,0) = phi(x) =u0, 0&lt;=x&lt;=1</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,9" id="srcline9">  9</a></span><span class="line"><span class="comment">% In this problem we take f(x,t) =1 for all x and t</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,10" id="srcline10"> 10</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,11" id="srcline11"> 11</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,12" id="srcline12"> 12</a></span><span class="line"><span class="comment">% The convention for most matrices is that rows are time, columns are space</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,13" id="srcline13"> 13</a></span><span class="line"><span class="var type0" id="S5T0U10">alpha</span>    = -1; <span class="comment">% for the boundary condition</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,14" id="srcline14"> 14</a></span><span class="line"><span class="var type0" id="S6T0U15">lambda</span>   = 1.7; <span class="comment">% regularization constant (affects smoothness of source solution)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,15" id="srcline15"> 15</a></span><span class="line"><span class="var type0" id="S7T0U19">regOrder</span> = 2;  <span class="comment">% Tikhonov regularization term order, [0,1,or 2]</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,16" id="srcline16"> 16</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,17" id="srcline17"> 17</a></span><span class="line"><span class="comment">% if ~exist('sigIn','var')</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,18" id="srcline18"> 18</a></span><span class="line"><span class="comment">%     N0     = 3;   % space points</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,19" id="srcline19"> 19</a></span><span class="line"><span class="comment">%     N      = 150; % time points</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,20" id="srcline20"> 20</a></span><span class="line"><span class="comment">%     % test signal</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,21" id="srcline21"> 21</a></span><span class="line"><span class="comment">%     sigIn      = (3*cos((1:N) *pi/8)./N+0.5*randn(1,N));% a vector of N points is the integral of the solution over the space</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,22" id="srcline22"> 22</a></span><span class="line"><span class="comment">%     E          = sigIn;</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,23" id="srcline23"> 23</a></span><span class="line"><span class="comment">% else</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,24" id="srcline24"> 24</a></span><span class="line">    <span class="var type1" id="S8T2U23">N0</span> = 3;        <span class="comment">% space points;</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,25" id="srcline25"> 25</a></span><span class="line">    <span class="var type1" id="S9T1U27">E</span>  = (<span class="var type1" id="S4T1U29">sigIn</span>);  <span class="comment">% int(u(x,t)dx) is a time function of size 1xN</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,26" id="srcline26"> 26</a></span><span class="line">    <span class="var type1" id="S10T2U32">N</span>  = numel(<span class="var type1" id="S9T1U35">E</span>); <span class="comment">% time points</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,27" id="srcline27"> 27</a></span><span class="line"><span class="comment">% end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,28" id="srcline28"> 28</a></span><span class="line"><span class="var type1" id="S12T3U38">f</span>      = 1*ones(<span class="var type1" id="S10T2U43">N</span>,<span class="var type1" id="S8T2U44">N0</span>); <span class="comment">% function of N time points over N0 space points</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,29" id="srcline29"> 29</a></span><span class="line"><span class="var type0" id="S14T0U47">u0</span>     = max(<span class="var type1" id="S9T1U52">E</span>(1:10))*ones(1,<span class="var type1" id="S8T2U59">N0</span>); <span class="comment">% is the phi function</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,30" id="srcline30"> 30</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,31" id="srcline31"> 31</a></span><span class="line"><span class="comment">% Discretize the time and space domain</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,32" id="srcline32"> 32</a></span><span class="line"><span class="var type1" id="S16T2U62">T</span>      = numel(<span class="var type1" id="S9T1U65">E</span>);         <span class="comment">% max time;</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,33" id="srcline33"> 33</a></span><span class="line"><span class="var type1" id="S17T1U68">gridT</span>  = (0:(<span class="var type1" id="S10T2U74">N</span>)).*(<span class="var type1" id="S16T2U77">T</span>/<span class="var type1" id="S10T2U78">N</span>);<span class="comment">% N+1 points</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,34" id="srcline34"> 34</a></span><span class="line"><span class="var type1" id="S18T1U81">t</span>      = zeros(1,<span class="var type1" id="S10T2U85">N</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,35" id="srcline35"> 35</a></span><span class="line"><span class="keyword">for</span> <span class="var type1" id="S20T2U88">tIdx</span> = 1:<span class="var type1" id="S10T2U91">N</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,36" id="srcline36"> 36</a></span><span class="line">    <span class="var type1" id="S18T1U95">t</span>(<span class="var type1" id="S20T2U96">tIdx</span>) = (<span class="var type1" id="S17T1U101">gridT</span>(<span class="var type1" id="S20T2U102">tIdx</span>)+<span class="var type1" id="S17T1U104">gridT</span>(<span class="var type1" id="S20T2U106">tIdx</span>+1))/2;</span></span>
<span class="srcline"><span class="lineno"><a href="1,37" id="srcline37"> 37</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,38" id="srcline38"> 38</a></span><span class="line"><span class="var type1" id="S21T23U111">gridX</span> = (0:(<span class="var type1" id="S8T2U117">N0</span>))./<span class="var type1" id="S8T2U118">N0</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,39" id="srcline39"> 39</a></span><span class="line"><span class="var type1" id="S22T14U121">x</span>     = zeros(1,<span class="var type1" id="S8T2U125">N0</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,40" id="srcline40"> 40</a></span><span class="line"><span class="keyword">for</span> <span class="var type1" id="S23T2U128">xIdx</span> = 1:numel(<span class="var type1" id="S22T14U133">x</span>)</span></span>
<span class="srcline"><span class="lineno"><a href="1,41" id="srcline41"> 41</a></span><span class="line">    <span class="var type1" id="S22T14U137">x</span>(<span class="var type1" id="S23T2U138">xIdx</span>) = (<span class="var type1" id="S21T23U143">gridX</span>(<span class="var type1" id="S23T2U145">xIdx</span>+1)+<span class="var type1" id="S21T23U148">gridX</span>(<span class="var type1" id="S23T2U149">xIdx</span>))/2;</span></span>
<span class="srcline"><span class="lineno"><a href="1,42" id="srcline42"> 42</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,43" id="srcline43"> 43</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,44" id="srcline44"> 44</a></span><span class="line"><span class="comment">% Determine the boundary and initial functions</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,45" id="srcline45"> 45</a></span><span class="line"><span class="comment">% u(0,t) = h0j</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,46" id="srcline46"> 46</a></span><span class="line"><span class="var type0" id="S24T0U153">h0j</span> = zeros(<span class="var type1" id="S10T2U156">N</span>,1);</span></span>
<span class="srcline"><span class="lineno"><a href="1,47" id="srcline47"> 47</a></span><span class="line"><span class="comment">% u(1,t) = h1j</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,48" id="srcline48"> 48</a></span><span class="line"><span class="var type0" id="S25T0U160">h1j</span> = zeros(<span class="var type1" id="S10T2U163">N</span>,1);</span></span>
<span class="srcline"><span class="lineno"><a href="1,49" id="srcline49"> 49</a></span><span class="line"><span class="comment">% du/dn(0,t) = q0j</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,50" id="srcline50"> 50</a></span><span class="line"><span class="var type0" id="S26T0U167">q0j</span> = zeros(<span class="var type1" id="S10T2U170">N</span>,1);</span></span>
<span class="srcline"><span class="lineno"><a href="1,51" id="srcline51"> 51</a></span><span class="line"><span class="comment">%du/dn(1,t) = q1j</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,52" id="srcline52"> 52</a></span><span class="line"><span class="var type0" id="S27T0U174">q1j</span> = zeros(<span class="var type1" id="S10T2U177">N</span>,1);</span></span>
<span class="srcline"><span class="lineno"><a href="1,53" id="srcline53"> 53</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,54" id="srcline54"> 54</a></span><span class="line"><span class="comment">%===========================</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,55" id="srcline55"> 55</a></span><span class="line"><span class="comment">% Calculate the matrix for the Acoeff,Bcoeff, BStar, D, C to be used later</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,56" id="srcline56"> 56</a></span><span class="line"><span class="comment">% for A,B,C,D</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,57" id="srcline57"> 57</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,58" id="srcline58"> 58</a></span><span class="line"><span class="comment">% the spatial domain for the calculation is the [0, x, 1]</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,59" id="srcline59"> 59</a></span><span class="line"><span class="comment">% xPoints   = [0, x, 1]; % add boundary points to the intermidiate ones</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,60" id="srcline60"> 60</a></span><span class="line"><span class="comment">% Nx        = numel(xPoints);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,61" id="srcline61"> 61</a></span><span class="line"><span class="comment">% aCoeffMat0 = zeros(N,Nx);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,62" id="srcline62"> 62</a></span><span class="line"><span class="comment">% aCoeffMat1 = zeros(N,Nx);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,63" id="srcline63"> 63</a></span><span class="line"><span class="comment">% bCoeffMat0 = zeros(N,Nx);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,64" id="srcline64"> 64</a></span><span class="line"><span class="comment">% bCoeffMat1 = zeros(N,Nx);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,65" id="srcline65"> 65</a></span><span class="line"><span class="comment">% for j=1:numel(xPoints)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,66" id="srcline66"> 66</a></span><span class="line"><span class="comment">%     for i=1:N</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,67" id="srcline67"> 67</a></span><span class="line"><span class="comment">%         aCoeffMat0(i,j) = Acoeff(0,xPoints(j),t(i),gridT(i:i+1));</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,68" id="srcline68"> 68</a></span><span class="line"><span class="comment">%         aCoeffMat1(i,j) = Acoeff(1,xPoints(j),t(i),gridT(i:i+1));</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,69" id="srcline69"> 69</a></span><span class="line"><span class="comment">%         bCoeffMat0(i,j) = Bcoeff(0,xPoints(j),t(i),gridT(i:i+1));</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,70" id="srcline70"> 70</a></span><span class="line"><span class="comment">%         bCoeffMat1(i,j) = Bcoeff(1,xPoints(j),t(i),gridT(i:i+1));</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,71" id="srcline71"> 71</a></span><span class="line"><span class="comment">%     end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,72" id="srcline72"> 72</a></span><span class="line"><span class="comment">% end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,73" id="srcline73"> 73</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,74" id="srcline74"> 74</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,75" id="srcline75"> 75</a></span><span class="line"><span class="comment">% Calculate the Boundary Elements</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,76" id="srcline76"> 76</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,77" id="srcline77"> 77</a></span><span class="line"><span class="comment">% Calculate A and B, B*, and D</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,78" id="srcline78"> 78</a></span><span class="line"><span class="var type0" id="S28T0U181">A</span>      = zeros(2*<span class="var type1" id="S10T2U186">N</span>,2*<span class="var type1" id="S10T2U189">N</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,79" id="srcline79"> 79</a></span><span class="line"><span class="var type0" id="S29T0U192">B</span>      = zeros(2*<span class="var type1" id="S10T2U197">N</span>,2*<span class="var type1" id="S10T2U200">N</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,80" id="srcline80"> 80</a></span><span class="line"><span class="var type0" id="S30T0U203">Bstar</span>  = zeros(2*<span class="var type1" id="S10T2U208">N</span>,2*<span class="var type1" id="S10T2U211">N</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,81" id="srcline81"> 81</a></span><span class="line"><span class="var type0" id="S31T0U214">D</span>      = zeros(2*<span class="var type1" id="S10T2U219">N</span>,<span class="var type1" id="S10T2U220">N</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,82" id="srcline82"> 82</a></span><span class="line"><span class="keyword">for</span> <span class="var type1" id="S32T2U223">j</span> = 1:<span class="var type1" id="S10T2U226">N</span> <span class="comment">% time</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,83" id="srcline83"> 83</a></span><span class="line">    <span class="keyword">for</span> <span class="var type1" id="S33T2U229">i</span> = 1:<span class="var type1" id="S10T2U232">N</span> <span class="comment">% time</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,84" id="srcline84"> 84</a></span><span class="line">        <span class="var type0" id="S34T0U235">deltaij</span> = double(<span class="var type1" id="S33T2U239">i</span>==<span class="var type1" id="S32T2U240">j</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,85" id="srcline85"> 85</a></span><span class="line"><span class="comment">%         A(2*i-1:2*i,2*j-1:2*j) = [aCoeffMat0(1,i), aCoeffMat1(1,i);<span class="keyword">...</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,86" id="srcline86"> 86</a></span><span class="line"><span class="comment">%                                   aCoeffMat0(end,i), aCoeffMat1(end,i)];</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,87" id="srcline87"> 87</a></span><span class="line">        <span class="var type0" id="S28T0U244">A</span>(2*<span class="var type0" id="S33T0U249">i</span>-1:2*<span class="var type0" id="S33T0U253">i</span>,2*<span class="var type0" id="S32T0U258">j</span>-1:2*<span class="var type0" id="S32T0U262">j</span>) = [<span class="message error" id="M1F1C"><span class="fcn" id="F110N3:B266">Acoeff</span>(0,<span class="var type1" id="S32T2U268">j</span>,0,<span class="var type1" id="S18T1U271">t</span>(<span class="var type1" id="S33T2U272">i</span>),<span class="var type1" id="S17T1U273">gridT</span>)</span>, Acoeff(1,<span class="var type0" id="S32T0U277">j</span>,0,<span class="var type0" id="S18T0U280">t</span>(<span class="var type0" id="S33T0U281">i</span>),<span class="var type0" id="S17T0U282">gridT</span>);<span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,88" id="srcline88"> 88</a></span><span class="line">                                  Acoeff(0,<span class="var type0" id="S32T0U287">j</span>,1,<span class="var type0" id="S18T0U290">t</span>(<span class="var type0" id="S33T0U291">i</span>),<span class="var type0" id="S17T0U292">gridT</span>), Acoeff(1,<span class="var type0" id="S32T0U296">j</span>,1,<span class="var type0" id="S18T0U299">t</span>(<span class="var type0" id="S33T0U300">i</span>),<span class="var type0" id="S17T0U301">gridT</span>)];</span></span>
<span class="srcline"><span class="lineno"><a href="1,89" id="srcline89"> 89</a></span><span class="line">        <span class="comment">% temp terms</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,90" id="srcline90"> 90</a></span><span class="line">        <span class="var type0" id="S37T0U304">b1j0i</span> = <span class="message error" id="M2F1C"><span class="fcn" id="F114N5:B306">Bcoeff</span>(1,<span class="var type1" id="S32T2U308">j</span>,0,<span class="var type1" id="S18T1U311">t</span>(<span class="var type1" id="S33T2U312">i</span>),<span class="var type1" id="S17T1U313">gridT</span>)</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,91" id="srcline91"> 91</a></span><span class="line">        <span class="var type0" id="S39T0U316">b1j1i</span> = <span class="message error" id="M3F1C"><span class="fcn" id="F138N5:B318">Bcoeff</span>(1,<span class="var type1" id="S32T2U320">j</span>,1,<span class="var type1" id="S18T1U323">t</span>(<span class="var type1" id="S33T2U324">i</span>),<span class="var type1" id="S17T1U325">gridT</span>)</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,92" id="srcline92"> 92</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="1,93" id="srcline93"> 93</a></span><span class="line">        <span class="var type0" id="S29T0U329">B</span>(2*<span class="var type0" id="S33T0U334">i</span>-1:2*<span class="var type0" id="S33T0U338">i</span>,2*<span class="var type0" id="S32T0U343">j</span>-1:2*<span class="var type0" id="S32T0U347">j</span>) = [<span class="message error" id="M4F1C"><span class="fcn" id="F139N5:B352">Bcoeff</span>(0,<span class="var type1" id="S32T2U354">j</span>,0,<span class="var type1" id="S18T1U357">t</span>(<span class="var type1" id="S33T2U358">i</span>),<span class="var type1" id="S17T1U359">gridT</span>)</span>+0.5*<span class="var type0" id="S34T0U362">deltaij</span>, <span class="var type0" id="S37T0U363">b1j0i</span>;<span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,94" id="srcline94"> 94</a></span><span class="line">                                  Bcoeff(0,<span class="var type0" id="S32T0U368">j</span>,1,<span class="var type0" id="S18T0U371">t</span>(<span class="var type0" id="S33T0U372">i</span>),<span class="var type0" id="S17T0U373">gridT</span>), <span class="var type0" id="S39T0U375">b1j1i</span>+0.5*<span class="var type0" id="S34T0U378">deltaij</span>];</span></span>
<span class="srcline"><span class="lineno"><a href="1,95" id="srcline95"> 95</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="1,96" id="srcline96"> 96</a></span><span class="line">        <span class="var type0" id="S30T0U382">Bstar</span>(2*<span class="var type0" id="S33T0U387">i</span>-1:2*<span class="var type0" id="S33T0U391">i</span>,2*<span class="var type0" id="S32T0U396">j</span>-1:2*<span class="var type0" id="S32T0U400">j</span>) = [<span class="var type0" id="S37T0U403"><span class="message error" id="M5F1C">b1j0i</span></span>,            -<span class="var type0" id="S37T0U405">b1j0i</span>;<span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,97" id="srcline97"> 97</a></span><span class="line">                                      <span class="var type0" id="S39T0U408">b1j1i</span>+<span class="var type0" id="S34T0U410">deltaij</span>/2, -<span class="var type0" id="S39T0U414">b1j1i</span>-0.5*<span class="var type0" id="S34T0U417">deltaij</span>];</span></span>
<span class="srcline"><span class="lineno"><a href="1,98" id="srcline98"> 98</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="1,99" id="srcline99"> 99</a></span><span class="line">        <span class="var type0" id="S31T0U421">D</span>(2*<span class="var type0" id="S33T0U426">i</span>-1:2*<span class="var type0" id="S33T0U430">i</span>,<span class="var type0" id="S32T0U431">j</span>)=[<span class="message error" id="M6F1C">Dcoeff(<span class="var type1" id="S22T14U436">x</span>,<span class="var type1" id="S32T2U437">j</span>,0,<span class="var type1" id="S18T1U440">t</span>(<span class="var type1" id="S33T2U441">i</span>),<span class="var type1" id="S17T1U442">gridT</span>,<span class="var type1" id="S12T3U444">f</span>(<span class="var type1" id="S33T2U445">i</span>,:))</span>;<span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,100" id="srcline100">100</a></span><span class="line">                        Dcoeff(<span class="var type0" id="S22T0U450">x</span>,<span class="var type0" id="S32T0U451">j</span>,1,<span class="var type0" id="S18T0U454">t</span>(<span class="var type0" id="S33T0U455">i</span>),<span class="var type0" id="S17T0U456">gridT</span>,<span class="var type0" id="S12T0U458">f</span>(<span class="var type0" id="S33T0U459">i</span>,:))];</span></span>
<span class="srcline"><span class="lineno"><a href="1,101" id="srcline101">101</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,102" id="srcline102">102</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,103" id="srcline103">103</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,104" id="srcline104">104</a></span><span class="line"><span class="comment">% Calculate C</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,105" id="srcline105">105</a></span><span class="line"><span class="var type0" id="S41T0U463">C</span> = zeros(2*<span class="var type1" id="S10T2U468">N</span>,<span class="var type1" id="S8T2U469">N0</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,106" id="srcline106">106</a></span><span class="line"><span class="keyword">for</span> <span class="var type1" id="S42T2U472">k</span> = 1:<span class="var type1" id="S8T2U475">N0</span><span class="comment">% space</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,107" id="srcline107">107</a></span><span class="line">    <span class="keyword">for</span> <span class="var type1" id="S33T2U478">i</span>=1:<span class="var type1" id="S10T2U481">N</span><span class="comment">% time</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,108" id="srcline108">108</a></span><span class="line">        <span class="var type0" id="S41T0U485">C</span>(2*<span class="var type0" id="S33T0U490">i</span>-1:2*<span class="var type0" id="S33T0U494">i</span>,<span class="var type0" id="S42T0U495">k</span>) = [Ccoeff(<span class="var type1" id="S42T2U500">k</span>,0,<span class="var type1" id="S18T1U503">t</span>(<span class="var type1" id="S33T2U504">i</span>),<span class="var type1" id="S21T23U505">gridX</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,109" id="srcline109">109</a></span><span class="line">                          Ccoeff(<span class="var type1" id="S42T2U509">k</span>,1,<span class="var type1" id="S18T1U512">t</span>(<span class="var type1" id="S33T2U513">i</span>),<span class="var type1" id="S21T23U514">gridX</span>)];</span></span>
<span class="srcline"><span class="lineno"><a href="1,110" id="srcline110">110</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,111" id="srcline111">111</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,112" id="srcline112">112</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,113" id="srcline113">113</a></span><span class="line"><span class="comment">% Solve the equation</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,114" id="srcline114">114</a></span><span class="line"><span class="comment">% r =((X'*X+lambda*regTerm)^-1)*X'Y, with r the source and X and Y are to be</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,115" id="srcline115">115</a></span><span class="line"><span class="comment">% calculated</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,116" id="srcline116">116</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,117" id="srcline117">117</a></span><span class="line"><span class="comment">% Calculate the components of X and Y</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,118" id="srcline118">118</a></span><span class="line"><span class="var type0" id="S44T0U517">s1</span> = zeros(<span class="var type1" id="S10T2U520">N</span>,<span class="var type1" id="S10T2U521">N</span>,<span class="var type1" id="S8T2U522">N0</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,119" id="srcline119">119</a></span><span class="line"><span class="var type0" id="S45T0U525">s2</span> = zeros(<span class="var type1" id="S10T2U528">N</span>,<span class="var type1" id="S8T2U529">N0</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,120" id="srcline120">120</a></span><span class="line"><span class="keyword">for</span> <span class="var type1" id="S42T2U532">k</span> = 1:<span class="var type1" id="S8T2U535">N0</span><span class="comment">% space variable</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,121" id="srcline121">121</a></span><span class="line">    <span class="comment">% components of X</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,122" id="srcline122">122</a></span><span class="line">    <span class="var type0" id="S46T0U538">a1k</span> = <span class="message error" id="M7F1C"><span class="fcn" id="F149N4:B540">Aone</span>(<span class="var type1" id="S42T2U541">k</span>,<span class="var type1" id="S22T14U542">x</span>,<span class="var type1" id="S18T1U543">t</span>,<span class="var type1" id="S17T1U544">gridT</span>)</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,123" id="srcline123">123</a></span><span class="line">    <span class="var type0" id="S48T0U547">b1k</span> = <span class="message error" id="M8F1C"><span class="fcn" id="F151N6:B549">Bone</span>(<span class="var type1" id="S42T2U550">k</span>,<span class="var type1" id="S22T14U551">x</span>,<span class="var type1" id="S18T1U552">t</span>,<span class="var type1" id="S17T1U553">gridT</span>)</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,124" id="srcline124">124</a></span><span class="line">    <span class="var type0" id="S50T0U556">b1s</span> = <span class="message fatal" id="M9F1C"><span class="fcn" id="F153N7:B558">BoneStar</span>(<span class="var type1" id="S42T2U559">k</span>,<span class="var type1" id="S22T14U560">x</span>,<span class="var type1" id="S18T1U561">t</span>,<span class="var type1" id="S17T1U562">gridT</span>)</span>; </span></span>
<span class="srcline"><span class="lineno"><a href="1,125" id="srcline125">125</a></span><span class="line">    <span class="var type0" id="S52T0U565">ax</span>  = (<span class="var type0" id="S46T0U569">a1k</span>-(1/<span class="var type0" id="S5T0U574">alpha</span>)*(<span class="var type0" id="S48T0U577">b1k</span>-<span class="var type0" id="S50T0U578">b1s</span>))/<span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,126" id="srcline126">126</a></span><span class="line">         (<span class="var type0" id="S28T0U581">A</span>-(1/<span class="var type0" id="S5T0U586">alpha</span>)*(<span class="var type0" id="S29T0U589">B</span>+<span class="var type0" id="S30T0U590">Bstar</span>));</span></span>
<span class="srcline"><span class="lineno"><a href="1,127" id="srcline127">127</a></span><span class="line">    <span class="var type0" id="S44T0U594">s1</span>(:,:,<span class="var type0" id="S42T0U597">k</span>) = (1/<span class="var type0" id="S8T0U602">N0</span>).*(-<span class="var type0" id="S52T0U607">ax</span>*<span class="var type0" id="S31T0U608">D</span> + Done(<span class="var type0" id="S42T0U611">k</span>,<span class="var type0" id="S22T0U612">x</span>,<span class="var type0" id="S18T0U613">t</span>,<span class="var type0" id="S17T0U614">gridT</span>,<span class="var type0" id="S12T0U615">f</span>));</span></span>
<span class="srcline"><span class="lineno"><a href="1,128" id="srcline128">128</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,129" id="srcline129">129</a></span><span class="line">    <span class="comment">% components of Y</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,130" id="srcline130">130</a></span><span class="line">    <span class="var type0" id="S54T0U618">ay</span> = (<span class="var type0" id="S46T0U622">a1k</span>-(1/<span class="var type0" id="S5T0U627">alpha</span>)*(<span class="var type0" id="S48T0U630">b1k</span>+<span class="var type0" id="S50T0U631">b1s</span>))/<span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,131" id="srcline131">131</a></span><span class="line">         (<span class="var type0" id="S28T0U634">A</span>-(1/<span class="var type0" id="S5T0U639">alpha</span>)*(<span class="var type0" id="S29T0U642">B</span>+<span class="var type0" id="S30T0U643">Bstar</span>));</span></span>
<span class="srcline"><span class="lineno"><a href="1,132" id="srcline132">132</a></span><span class="line">    <span class="var type0" id="S45T0U647">s2</span>(:,<span class="var type0" id="S42T0U649">k</span>) = (1/<span class="var type0" id="S8T0U655">N0</span>)*(<span class="var type0" id="S54T0U659">ay</span>*<span class="var type0" id="S41T0U660">C</span>-Cone(<span class="var type0" id="S22T0U663">x</span>,<span class="var type0" id="S21T0U664">gridX</span>,<span class="var type0" id="S18T0U665">t</span>))*<span class="var type0" id="S14T0U667">u0</span>' ;</span></span>
<span class="srcline"><span class="lineno"><a href="1,133" id="srcline133">133</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,134" id="srcline134">134</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,135" id="srcline135">135</a></span><span class="line"><span class="var type0" id="S56T0U670">X</span> = sum(<span class="var type0" id="S44T0U673">s1</span>,3);</span></span>
<span class="srcline"><span class="lineno"><a href="1,136" id="srcline136">136</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,137" id="srcline137">137</a></span><span class="line"><span class="var type0" id="S58T0U677">Y</span> = <span class="var type0" id="S9T0U680">E</span>'+sum(<span class="var type0" id="S45T0U683">s2</span>,2);</span></span>
<span class="srcline"><span class="lineno"><a href="1,138" id="srcline138">138</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,139" id="srcline139">139</a></span><span class="line"><span class="var type0" id="S59T0U687">regTerm</span> = GetRegularizationTerm(<span class="var type0" id="S10T0U690">N</span>,<span class="var type0" id="S7T0U691">regOrder</span>); <span class="comment">% get RregTerm= 'R term</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,140" id="srcline140">140</a></span><span class="line"><span class="comment">% The source solution with regularization coefficient lambda is</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,141" id="srcline141">141</a></span><span class="line"><span class="var type0" id="S3T0U694">r</span>   = ((<span class="var type0" id="S56T0U701">X</span>')*<span class="var type0" id="S56T0U702">X</span>+<span class="var type0" id="S6T0U704">lambda</span>*<span class="var type0" id="S59T0U705">regTerm</span>)\(<span class="var type0" id="S56T0U709">X</span>'*<span class="var type0" id="S58T0U710">Y</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,142" id="srcline142">142</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,143" id="srcline143">143</a></span><span class="line"><span class="comment">% Calculate the solution u(x,t)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,144" id="srcline144">144</a></span><span class="line"><span class="comment">% eta     = ones(1,N0);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,145" id="srcline145">145</a></span><span class="line"><span class="comment">% eta(1)  = 0.5;</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,146" id="srcline146">146</a></span><span class="line"><span class="comment">% eta(N0) = 0.5;</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,147" id="srcline147">147</a></span><span class="line"><span class="var type0" id="S2T0U713">u</span>       = zeros(<span class="var type0" id="S10T0U716">N</span>,<span class="var type0" id="S8T0U717">N0</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,148" id="srcline148">148</a></span><span class="line"><span class="comment">% for j=1:N0    % space index</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,149" id="srcline149">149</a></span><span class="line"><span class="comment">%     for i=1:N % time index</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,150" id="srcline150">150</a></span><span class="line"><span class="comment">%         sTime   = 0;% cumulative sums</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,151" id="srcline151">151</a></span><span class="line"><span class="comment">%         sSpace  = 0;</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,152" id="srcline152">152</a></span><span class="line"><span class="comment">%         </span></span></span>
<span class="srcline"><span class="lineno"><a href="1,153" id="srcline153">153</a></span><span class="line"><span class="comment">%         for stIdx = 1:N % time index</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,154" id="srcline154">154</a></span><span class="line"><span class="comment">%             sTime = sTime+ Acoeff(0,stIdx,x(j),t(i),gridT)*q0j(stIdx) + Acoeff(1,stIdx,x(j),t(i), gridT)*q1j(stIdx)-<span class="keyword">...</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,155" id="srcline155">155</a></span><span class="line"><span class="comment">%                 Bcoeff(0,stIdx,x(j),t(i),gridT)*h0j(stIdx) - Bcoeff(1,stIdx,x(j),t(i), gridT)*h1j(stIdx)+<span class="keyword">...</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,156" id="srcline156">156</a></span><span class="line"><span class="comment">%                 Dcoeff(x,stIdx,x(j),t(i),gridT,f(i,:))*r(stIdx);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,157" id="srcline157">157</a></span><span class="line"><span class="comment">%         end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,158" id="srcline158">158</a></span><span class="line"><span class="comment">%         </span></span></span>
<span class="srcline"><span class="lineno"><a href="1,159" id="srcline159">159</a></span><span class="line"><span class="comment">%         for ssIdx = 1:N0 % space index</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,160" id="srcline160">160</a></span><span class="line"><span class="comment">%             sSpace = sSpace +Ccoeff(ssIdx,x(j),t(i),gridT)*u0(ssIdx);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,161" id="srcline161">161</a></span><span class="line"><span class="comment">%         end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,162" id="srcline162">162</a></span><span class="line"><span class="comment">%         u(i,j) = (sTime+sSpace)*eta(j);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,163" id="srcline163">163</a></span><span class="line"><span class="comment">%     end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,164" id="srcline164">164</a></span><span class="line"><span class="comment">% end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,165" id="srcline165">165</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,166" id="srcline166">166</a></span><span class="line">PlotResults(<span class="var type0" id="S18T0U721">t</span>,<span class="var type0" id="S4T0U722">sigIn</span>,<span class="var type0" id="S2T0U723">u</span>,<span class="var type0" id="S3T0U724">r</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,167" id="srcline167">167</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,168" id="srcline168">168</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,169" id="srcline169">169</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,170" id="srcline170">170</a></span><span class="line"></span></span>
</pre>
